# 陶瓷电炉项目架构说明

## 项目概述

**类型**: Windows 工业监控应用
**技术栈**: Flutter 3.22.x + Dart
**通信协议**: Siemens S7-1200 PLC (dart_snap7)
**后端**: FastAPI + InfluxDB

## 核心架构

```
┌─────────────────────────────────────────────────────────┐
│              Flutter 前端应用                      │
│  ┌──────────┬──────────┬──────────┐          │
│  │ 实时监控  │ 历史数据  │ 设置管理  │          │
│  └──────────┴──────────┴──────────┘          │
└────────────────────┬────────────────────────────────┘
                   │ HTTP API
┌────────────────────▼────────────────────────────────┐
│              FastAPI 后端服务                    │
│  ┌──────────┬──────────┬──────────┐          │
│  │ PLC 轮询  │ 数据转换  │ API 路由  │          │
│  └──────────┴──────────┴──────────┘          │
└────────────────────┬────────────────────────────────┘
                   │ S7 Protocol
┌────────────────────▼────────────────────────────────┐
│              S7-1200 PLC                       │
│  DB32: 传感器数据  DB30: 设备状态              │
└───────────────────────────────────────────────────────┘
```

## 目录结构

```
lib/
├── main.dart              # 应用入口
├── api/                  # API 调用层
│   ├── api.dart          # 基础配置
│   ├── batch_api.dart    # 批次管理
│   ├── control_api.dart  # 控制接口
│   ├── history_api.dart  # 历史数据
│   └── status_service.dart # 状态查询
├── models/               # 数据模型
│   ├── app_state.dart    # 应用状态
│   ├── realtime_data.dart # 实时数据
│   └── valve_status.dart # 阀门状态
├── pages/               # 页面
│   ├── home.dart        # 主页
│   ├── realtime_data_page.dart # 实时数据
│   ├── history_curve_page.dart # 历史曲线
│   └── settings_page.dart # 设置
├── widgets/             # 组件
│   ├── common/          # 通用组件
│   ├── realtime_data/   # 实时数据组件
│   ├── history_curve/   # 历史曲线组件
│   └── shared/         # 共享组件
├── services/            # 业务服务
│   └── alarm_service.dart # 警报服务
└── tools/              # 工具类
    └── valve_calculator.dart # 阀门计算
```

## 核心功能模块

### 1. 实时监控
- 弧流/弧压数据（200ms 轮询）
- 传感器数据（500ms 轮询）
- 阀门状态实时显示
- 电极电流图表

### 2. 历史数据
- 批次选择器
- 时间范围选择
- 曲线图/柱状图展示
- 数据导出功能

### 3. 批次管理
- 开始/暂停/恢复/停止冶炼
- 批次编号生成（YYMMFFDD 格式）
- 状态持久化

### 4. 设备控制
- 蝶阀开关控制
- 阀门状态监控
- 双速控制

## 技术规范

### 数据刷新率
| 数据类型 | 刷新间隔 | 同步延迟 |
|---------|----------|---------|
| 弧流/弧压 | 200ms | - |
| 传感器数据 | 500ms | - |
| 历史数据 | 按需 | - |

### UI 设计原则
- **功能优先**: 清晰 > 可靠 > 美观
- **科技风格**: 深色主题（青色发光边框）
- **固定窗口**: 1536×864，不可调整大小
- **Tab 导航**: 模块化页面切换

### 性能优化
- Timer 生命周期管理（dispose 必须取消）
- HTTP Client 单例 + 超时控制（10-15s）
- IndexedStack 配合 GlobalKey 控制轮询暂停/恢复
- 避免内存泄漏（工控机 7×24 小时运行）

## 开发规范

### 代码规范
- 文件注释：`// 序号: 简短注释`
- 避免中文乱码：所有文件使用 UTF-8 编码
- 奥卡姆剃刀原则：如无必要，勿增实体

### Git 工作流
```bash
# 开发前拉取最新代码
git pull origin main

# 提交修改
git add .
git commit -m "feat: 功能描述"

# 推送到远程
git push origin main
```

### 测试命令
```bash
# 代码分析
flutter analyze

# 运行应用
flutter run -d windows

# 构建发布版本
flutter build windows
```

## 注意事项

1. **编码问题**: 所有文件必须使用 UTF-8 编码，避免中文乱码
2. **Timer 管理**: 每个 Timer.periodic 必须有对应的 cancel()
3. **HTTP 超时**: 所有请求必须设置 timeout（10-15s）
4. **主题切换**: 使用 AppTheme 替代 TechColors，支持深色/浅色主题
5. **工控机部署**: 考虑长时间运行、内存有限、网络不稳定
